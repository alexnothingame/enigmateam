
services:
  redis:
    image: redis:7-alpine
    container_name: tg_redis
    restart: unless-stopped
    volumes:
      - redis_data:/data

  bot-logic-1:
    build:
      context: .
      dockerfile: deploy/Dockerfile.bot-logic
    environment:
      - REDIS_ADDR=redis:6379
      - REDIS_PASSWORD=
      - AUTH_BASE_URL=${AUTH_BASE_URL:-http://auth:8000}
      - MAIN_BASE_URL=${MAIN_BASE_URL:-http://main:8080}
      - MAIN_NOTIFICATION_PATH=${MAIN_NOTIFICATION_PATH:-/notification}
      - MAIN_NOTIFICATION_ACK_PATH=${MAIN_NOTIFICATION_ACK_PATH:-/notification/ack}
      - SESSION_TTL=72h
      - LISTEN_ADDR=:8080
    depends_on:
      - redis
    restart: unless-stopped

  bot-logic-2:
    build:
      context: .
      dockerfile: deploy/Dockerfile.bot-logic
    environment:
      - REDIS_ADDR=redis:6379
      - REDIS_PASSWORD=
      - AUTH_BASE_URL=${AUTH_BASE_URL:-http://auth:8000}
      - MAIN_BASE_URL=${MAIN_BASE_URL:-http://main:8080}
      - MAIN_NOTIFICATION_PATH=${MAIN_NOTIFICATION_PATH:-/notification}
      - MAIN_NOTIFICATION_ACK_PATH=${MAIN_NOTIFICATION_ACK_PATH:-/notification/ack}
      - SESSION_TTL=72h
      - LISTEN_ADDR=:8080
    depends_on:
      - redis
    restart: unless-stopped

  nginx:
    image: nginx:1.27-alpine
    container_name: tg_nginx
    volumes:
      - ./deploy/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - bot-logic-1
      - bot-logic-2
    ports:
      - "8080:8080"
    restart: unless-stopped

  telegram-client:
    build:
      context: .
      dockerfile: deploy/Dockerfile.telegram-client
    environment:
      - TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
      - BOT_LOGIC_URL=http://nginx:8080
      - CRON_CHECK_LOGIN_EVERY=10s
      - CRON_CHECK_NOTIF_EVERY=20s
      - POLL_TIMEOUT=60
    depends_on:
      - nginx
    restart: unless-stopped

volumes:
  redis_data:
